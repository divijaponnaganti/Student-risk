{% extends "base.html" %}

{% block title %}Administrator Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-user-shield text-primary me-2"></i>
                        Administrator Dashboard
                    </h1>
                    <p class="text-muted mb-0">System management and oversight</p>
                </div>
                <div>
                    <span class="badge bg-primary fs-6">
                        <i class="fas fa-user me-1"></i>
                        {{ current_user.get_full_name() }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- System Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-3">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h4 class="card-title">{{ stats.total_users or 0 }}</h4>
                    <p class="card-text text-muted">Total Users</p>
                    <small class="text-success">
                        <i class="fas fa-arrow-up me-1"></i>
                        {{ stats.new_users_this_month or 0 }} this month
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-3">
                        <i class="fas fa-graduation-cap fa-2x"></i>
                    </div>
                    <h4 class="card-title">{{ stats.total_students or 0 }}</h4>
                    <p class="card-text text-muted">Total Students (dataset)</p>
                    <small class="text-info d-block">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {{ stats.high_risk_students or 0 }} high risk
                    </small>
                    <small class="text-secondary d-block">
                        <i class="fas fa-user-check me-1"></i>
                        Registered: {{ stats.registered_students or 0 }}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-3">
                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                    </div>
                    <h4 class="card-title">{{ stats.total_faculty or 0 }}</h4>
                    <p class="card-text text-muted">Faculty Members</p>
                    <small class="text-primary">
                        <i class="fas fa-check-circle me-1"></i>
                        {{ stats.active_faculty or 0 }} active
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-3">
                        <i class="fas fa-brain fa-2x"></i>
                    </div>
                    <h4 class="card-title">{{ model_info.accuracy or 'N/A' }}%</h4>
                    <p class="card-text text-muted">Model Accuracy</p>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Last trained: {{ model_info.last_trained or 'Never' }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>Manage Users
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                                <i class="fas fa-upload me-2"></i>Upload Data
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="model-tab" data-bs-toggle="tab" data-bs-target="#model" type="button" role="tab">
                                <i class="fas fa-brain me-2"></i>Model Training
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>System Overview
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="adminTabsContent">
                        <!-- Manage Users Tab -->
                        <div class="tab-pane fade show active" id="users" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">User Management</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="fas fa-plus me-2"></i>Add New User
                                </button>
                            </div>
                            
                            <!-- User Filters -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="roleFilter">
                                        <option value="">All Roles</option>
                                        <option value="administrator">Administrator</option>
                                        <option value="faculty">Faculty</option>
                                        <option value="student">Student</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="searchUsers" placeholder="Search users...">
                                </div>
                            </div>
                            
                            <!-- Users Table -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="usersTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm me-2">
                                                        {% if user.role == 'administrator' %}
                                                            <i class="fas fa-user-shield text-primary"></i>
                                                        {% elif user.role == 'faculty' %}
                                                            <i class="fas fa-chalkboard-teacher text-success"></i>
                                                        {% else %}
                                                            <i class="fas fa-user-graduate text-info"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <strong>{{ user.get_full_name() }}</strong>
                                                        {% if user.student_id %}
                                                            <br><small class="text-muted">ID: {{ user.student_id }}</small>
                                                        {% elif user.faculty_id %}
                                                            <br><small class="text-muted">ID: {{ user.faculty_id }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if user.role == 'administrator' else 'success' if user.role == 'faculty' else 'info' }}">
                                                    {{ user.role.title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                                </span>
                                            </td>
                                            <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editUser({{ user.id }})" title="Edit User">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-{{ 'secondary' if user.is_active else 'success' }}" onclick="toggleUserStatus({{ user.id }})" title="{{ 'Deactivate' if user.is_active else 'Activate' }} User">
                                                        <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                                    </button>
                                                    {% if user.role == 'student' %}
                                                    <button class="btn btn-outline-warning" onclick="sendAlert({{ user.id }}, '{{ user.get_full_name() }}', '{{ user.student_id or 'N/A' }}')" title="Send Alert">
                                                        <i class="fas fa-bell"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Upload Data Tab -->
                        <div class="tab-pane fade" id="data" role="tabpanel">
                            <h5 class="mb-3">Data Upload & Management</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Student Data</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="uploadForm" enctype="multipart/form-data">
                                                <div class="mb-3">
                                                    <label class="form-label">CSV File</label>
                                                    <input type="file" class="form-control" name="file" accept=".csv" required>
                                                    <div class="form-text">Upload CSV file with student data</div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-upload me-2"></i>Upload & Process
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Upload Requirements</h6>
                                        </div>
                                        <div class="card-body">
                                            <p>Your CSV file should include these columns:</p>
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success me-2"></i>StudentID</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Name</li>
                                                <li><i class="fas fa-check text-success me-2"></i>Attendance</li>
                                                <li><i class="fas fa-check text-success me-2"></i>AverageScore</li>
                                                <li><i class="fas fa-check text-success me-2"></i>AssignmentsSubmitted</li>
                                                <li><i class="fas fa-check text-success me-2"></i>TotalAssignments</li>
                                                <li><i class="fas fa-check text-success me-2"></i>EngagementScore</li>
                                                <li><i class="fas fa-check text-success me-2"></i>PreviousGrade</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Model Training Tab -->
                        <div class="tab-pane fade" id="model" role="tabpanel">
                            <h5 class="mb-3">ML Model Training & Management</h5>
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">Current Model Status</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p><strong>Accuracy:</strong> {{ model_info.accuracy or 'N/A' }}%</p>
                                                    <p><strong>Last Trained:</strong> {{ model_info.last_trained or 'Never' }}</p>
                                                    <p><strong>Training Data Size:</strong> {{ model_info.training_size or 'N/A' }} records</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p><strong>Model Type:</strong> Random Forest</p>
                                                    <p><strong>Features:</strong> {{ model_info.features_count or 'N/A' }}</p>
                                                    <p><strong>Status:</strong> 
                                                        <span class="badge bg-{{ 'success' if model_info.is_trained else 'warning' }}">
                                                            {{ 'Trained' if model_info.is_trained else 'Not Trained' }}
                                                        </span>
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button class="btn btn-primary me-2" onclick="trainModel()">
                                                    <i class="fas fa-brain me-2"></i>Retrain Model
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="validateModel()">
                                                    <i class="fas fa-check-circle me-2"></i>Validate Model
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Training Tips</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled">
                                                <li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>Retrain after uploading new data</li>
                                                <li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>More data improves accuracy</li>
                                                <li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>Training may take a few minutes</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Overview Tab -->
                        <div class="tab-pane fade" id="overview" role="tabpanel">
                            <h5 class="mb-3">System Overview & Analytics</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Risk</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="riskChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">User Activity</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="activityChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Recent System Activity</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Time</th>
                                                            <th>User</th>
                                                            <th>Action</th>
                                                            <th>Details</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>2024-01-15 10:30</td>
                                                            <td>prof_smith</td>
                                                            <td>Risk Prediction</td>
                                                            <td>Predicted risk for student S001</td>
                                                        </tr>
                                                        <tr>
                                                            <td>2024-01-15 09:15</td>
                                                            <td>admin</td>
                                                            <td>Data Upload</td>
                                                            <td>Uploaded student_data.csv (150 records)</td>
                                                        </tr>
                                                        <tr>
                                                            <td>2024-01-15 08:45</td>
                                                            <td>alice_johnson</td>
                                                            <td>Login</td>
                                                            <td>Student portal access</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role" required>
                            <option value="">Select Role</option>
                            <option value="administrator">Administrator</option>
                            <option value="faculty">Faculty</option>
                            <option value="student">Student</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="studentIdField" style="display: none;">
                        <label class="form-label">Student ID</label>
                        <input type="text" class="form-control" name="student_id">
                    </div>
                    
                    <div class="mb-3" id="facultyIdField" style="display: none;">
                        <label class="form-label">Faculty ID</label>
                        <input type="text" class="form-control" name="faculty_id">
                    </div>
                    
                    <div class="mb-3" id="departmentField" style="display: none;">
                        <label class="form-label">Department</label>
                        <input type="text" class="form-control" name="department">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Role-based field visibility
document.querySelector('select[name="role"]').addEventListener('change', function() {
    const role = this.value;
    const studentIdField = document.getElementById('studentIdField');
    const facultyIdField = document.getElementById('facultyIdField');
    const departmentField = document.getElementById('departmentField');
    
    // Hide all fields first
    studentIdField.style.display = 'none';
    facultyIdField.style.display = 'none';
    departmentField.style.display = 'none';
    
    // Show relevant fields
    if (role === 'student') {
        studentIdField.style.display = 'block';
    } else if (role === 'faculty') {
        facultyIdField.style.display = 'block';
        departmentField.style.display = 'block';
    } else if (role === 'administrator') {
        departmentField.style.display = 'block';
    }
});

// Initialize charts
const riskCtx = document.getElementById('riskChart').getContext('2d');
new Chart(riskCtx, {
    type: 'doughnut',
    data: {
        labels: ['Critical Risk', 'High Risk', 'Medium Risk', 'Safe'],
        datasets: [{
            data: [
                {{ stats.critical_risk_students or 0 }},
                {{ stats.high_risk_students or 0 }},
                {{ stats.medium_risk_students or 0 }},
                {{ stats.safe_students or 0 }}
            ],
            backgroundColor: ['#8B0000', '#dc3545', '#ffc107', '#28a745']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

const activityCtx = document.getElementById('activityChart').getContext('2d');
new Chart(activityCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'User Logins',
            data: [12, 19, 3, 5, 2, 3, 10],
            borderColor: '#007bff',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Functions for user management
function editUser(userId) {
    // Show edit modal or inline editing
    const row = document.querySelector(`button[onclick="editUser(${userId})"]`).closest('tr');
    const name = row.cells[0].textContent.trim();
    const email = row.cells[2].textContent.trim();
    
    // Simple prompt for now - can be enhanced with a proper modal
    const newEmail = prompt(`Edit email for ${name}:`, email);
    if (newEmail && newEmail !== email) {
        fetch(`/admin/edit_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: newEmail
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the user.');
        });
    }
}

function toggleUserStatus(userId) {
    if (confirm('Are you sure you want to toggle this user\'s status?')) {
        fetch(`/admin/toggle_user_status/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating user status.');
        });
    }
}

function sendAlert(userId, userName, studentId) {
    if (studentId === 'N/A') {
        alert('Cannot send alert: Student ID not available for this user.');
        return;
    }
    
    const alertReason = prompt(`Send alert for student: ${userName} (ID: ${studentId})\n\nEnter alert reason (optional):`, 'Academic performance concern');
    
    if (alertReason !== null) {
        fetch(`/admin/send_alert/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                reason: alertReason,
                student_id: studentId,
                student_name: userName
            })
        })
        .then(async (response) => {
            const contentType = response.headers.get('content-type') || '';
            // If not JSON, likely redirected to login or an HTML error page
            if (!contentType.includes('application/json')) {
                alert('You may be logged out or lack permissions. Please log in as admin and try again.');
                return;
            }
            const data = await response.json();
            if (!response.ok) {
                alert('Error: ' + (data.message || 'Failed to send alert.'));
                return;
            }
            if (data.success) {
                alert(`Alert sent successfully!\n${data.message}`);
            } else {
                alert('Error: ' + (data.message || 'Failed to send alert.'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the alert.');
        });
    }
}

function trainModel() {
    if (confirm('This will retrain the ML model. This may take a few minutes. Continue?')) {
        alert('Model training started. This may take a few minutes...');
        // Add actual training implementation here
        console.log('Training model...');
    }
}

function validateModel() {
    alert('Model validation started...');
    // Add actual validation implementation here
    console.log('Validating model...');
}

// Search functionality
document.getElementById('searchUsers').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const name = row.cells[0].textContent.toLowerCase();
        const username = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const role = row.cells[3].textContent.toLowerCase();
        
        if (name.includes(searchTerm) || username.includes(searchTerm) || 
            email.includes(searchTerm) || role.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
});

// Role and status filters
document.getElementById('roleFilter').addEventListener('change', function() {
    filterUsers();
});

document.getElementById('statusFilter').addEventListener('change', function() {
    filterUsers();
});

function filterUsers() {
    const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const role = row.cells[3].textContent.toLowerCase();
        const status = row.cells[4].textContent.toLowerCase();
        
        let showRow = true;
        
        if (roleFilter && !role.includes(roleFilter)) {
            showRow = false;
        }
        
        if (statusFilter && !status.includes(statusFilter)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    }
}

// Add User Form Submission
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const userData = {};
    
    for (let [key, value] of formData.entries()) {
        userData[key] = value;
    }
    
    fetch('/admin/create_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the user.');
    });
});
</script>
{% endblock %}
